# ベンチマーク測定に関する注意事項

## 2倍以上の高速化率について

一部のベンチマーク結果で、2スレッド並列化にもかかわらず2倍以上の高速化率が見られるケースがあります。これは以下の理由によるものです。

### 理論的な上限

Amdahlの法則により、2スレッドで得られる理論的最大高速化率は2.0倍です。
しかし、実測値では以下の理由で2倍を超える場合があります：

### 1. 小さいグリッドサイズでの測定誤差

#### 64x64グリッドの例（C Single Thread）
```
試行  1: 5.739 ms
試行  2: 6.683 ms
...
試行 13: 1.425 ms  ← 最小値
試行 14: 2.554 ms
試行 15: 1.852 ms
---
最小値:   1.425 ms
中央値:   4.757 ms  ← これを使用
最大値:   6.697 ms
```

**問題**: 実行時間が1-7msと非常に短く、測定が不安定
- OSのタスクスケジューリングの影響
- CPUの周波数スケーリング
- キャッシュウォーミングの効果
- 測定オーバーヘッドが相対的に大きい

#### 1024x1024グリッドの例（Rust Single Thread）
```
試行  1: 316.551875ms
試行  2: 311.275417ms
...
試行 15: 309.796041ms
---
最小値:   307.734125ms
中央値:   309.318292ms
平均値:   311.656205ms
最大値:   338.57625ms
```

**改善**: 実行時間が300ms以上で測定が安定している

### 2. メモリアクセスパターンの違い

並列化実装では、グリッドを分割することで：
- **キャッシュ局所性が向上**する場合がある
- 各スレッドが小さいメモリ領域を集中的にアクセス
- キャッシュミスが減少

例：
- シングルスレッド: 1024x1024全体を順次処理（L2/L3キャッシュ）
- 2スレッド並列: 各スレッドが512x1024を処理（L1/L2キャッシュに収まりやすい）

### 3. 測定の信頼性

| グリッドサイズ | 実行時間 | 測定の信頼性 |
|:---|:---:|:---|
| 64x64 | ~5ms | ❌ 低い（変動大） |
| 128x128 | ~15ms | ⚠️ やや低い |
| 512x512 | ~75ms | ✅ 良好 |
| 1024x1024 | ~300ms | ✅ 非常に良好 |

### 4. 具体例の分析

#### ケース1: Rust Unsafe Semaphore (1024x1024)
```
シングルスレッド: 309.32 ms
Unsafe Semaphore: 144.55 ms
高速化率: 2.14x
```

**分析**:
- 測定は安定している（300ms級）
- 2.14xは理論値2.0xに近い
- 14%の超過は以下の可能性：
  - キャッシュ効率の向上
  - メモリ帯域の効率的利用
  - 測定誤差（約5%程度の変動あり）

#### ケース2: C Semaphore (64x64)
```
シングルスレッド: 4.76 ms（中央値）
C Semaphore: 3.93 ms
高速化率: 1.21x
```

**分析**:
- 測定時間が短すぎる（~5ms）
- 実際の高速化率は不確実
- 並列化オーバーヘッドで期待より低い

## 推奨事項

### 信頼できる結果

**512x512以上のグリッドサイズ**での測定結果を重視してください：

| グリッドサイズ | C Semaphore高速化率 | Rust Unsafe Semaphore高速化率 |
|:---|:---:|:---:|
| 512x512 | 2.01× | 1.91× |
| 1024x1024 | 2.01× | 2.14× |

これらは測定が安定しており、理論値（2.0x）に近い妥当な値です。

### 小さいグリッドの結果の扱い

64x64、128x128の結果は：
- ✅ **傾向**を見るための参考値として使用
- ❌ 絶対的な性能値としては使用しない
- ⚠️ 並列化オーバーヘッドの影響を理解するために有用

## 結論

1. **2倍以上の高速化は測定誤差またはキャッシュ効果**
   - 真の並列化効率は1.9-2.0x程度と推定
   
2. **小さいグリッドは測定が不安定**
   - マイクロベンチマークの限界
   
3. **大きいグリッド（512x512以上）の結果が信頼できる**
   - 実行時間が十分長い（>50ms）
   - 測定の変動が小さい

4. **実用的には問題ない**
   - 実際のアプリケーションでは大きいグリッドを使用
   - 512x512以上で1.9-2.0xの高速化が安定して得られている
