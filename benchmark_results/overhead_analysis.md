# ベンチマークオーバーヘッド分析

グリッドサイズごとのオーバーヘッド(ms)を、ベンチマーク実装別に分析します。

---

## 1. Semaphore実装

| グリッドサイズ | Rust Safe (ms) | Rust Unsafe (ms) | C (ms) | Safe - Unsafe<br>(基準: Unsafe) | Safe - C<br>(基準: C) | Unsafe - C<br>(基準: C) |
|:---|---:|---:|---:|---:|---:|---:|
| 64x64 | 4.90 | 4.83 | 3.93 | +0.07 (+1.4%) | +0.97 (+24.7%) | +0.90 (+22.9%) |
| 128x128 | 10.45 | 8.69 | 8.12 | +1.76 (+20.3%) | +2.33 (+28.7%) | +0.57 (+7.0%) |
| 512x512 | 43.70 | 40.66 | 37.88 | +3.04 (+7.5%) | +5.82 (+15.4%) | +2.78 (+7.3%) |
| 1024x1024 | 163.19 | 144.55 | 134.55 | +18.64 (+12.9%) | +28.64 (+21.3%) | +10.00 (+7.4%) |

**考察:**
- Unsafe Rustは、グリッドサイズが大きくなるほどC言語に近づく（C言語比で7-8%遅い）
- Safe RustはUnsafe比で1.4-20.3%遅い、C言語比で15-29%遅い

---

## 2. Barrier実装

| グリッドサイズ | Rust Safe (ms) | Rust Unsafe (ms) | C (ms) | Safe - Unsafe<br>(基準: Unsafe) | Safe - C<br>(基準: C) | Unsafe - C<br>(基準: C) |
|:---|---:|---:|---:|---:|---:|---:|
| 64x64 | 12.77 | 10.46 | 9.41 | +2.31 (+22.1%) | +3.36 (+35.7%) | +1.05 (+11.2%) |
| 128x128 | 18.92 | 15.16 | 15.82 | +3.76 (+24.8%) | +3.10 (+19.6%) | -0.66 (-4.2%) |
| 512x512 | 49.66 | 42.60 | 46.17 | +7.06 (+16.6%) | +3.49 (+7.6%) | -3.57 (-7.7%) |
| 1024x1024 | 174.56 | 153.85 | 165.88 | +20.71 (+13.5%) | +8.68 (+5.2%) | -12.03 (-7.3%) |

**考察:**
- Barrier Unsafeは、中規模以上(128x128以上)でC言語より高速（C言語比で4.2-7.7%速い）
- Safe RustはUnsafe比で13.5-24.8%遅い、C言語比で5.2-35.7%遅い

---

## 3. Rayon実装

| グリッドサイズ | Rust Safe (ms) | Rust Unsafe (ms) | C OpenMP (ms) | Safe - Unsafe<br>(基準: Unsafe) | Safe - OpenMP<br>(基準: OpenMP) | Unsafe - OpenMP<br>(基準: OpenMP) |
|:---|---:|---:|---:|---:|---:|---:|
| 64x64 | 13.50 | 12.88 | 22.92 | +0.62 (+4.8%) | -9.42 (-41.1%) | -10.04 (-43.8%) |
| 128x128 | 19.22 | 18.47 | 23.71 | +0.75 (+4.1%) | -4.49 (-18.9%) | -5.24 (-22.1%) |
| 512x512 | 48.00 | 49.63 | 39.10 | -1.63 (-3.3%) | +8.90 (+22.8%) | +10.53 (+26.9%) |
| 1024x1024 | 173.64 | 175.85 | 115.68 | -2.21 (-1.3%) | +57.96 (+50.1%) | +60.17 (+52.0%) |

**考察:**
- **特異なパターン**: 大規模グリッドでUnsafe版がSafe版より遅い（Unsafe比で1.3-3.3%速い）
- **OpenMPとの比較**: 小規模グリッド(64x64, 128x128)でRayonがOpenMPより18.9-43.8%高速
- **スケーラビリティの問題**: 大規模グリッド(512x512以上)でOpenMPがRayonを逆転（OpenMP比で22.8-52.0%遅い）
- OpenMPは大規模データで優れたスケーラビリティを示す

---

## 4. Single Thread実装

| グリッドサイズ | Rust (ms) | C (ms) | Rust - C<br>(基準: C) |
|:---|---:|---:|---:|
| 64x64 | 6.14 | 4.76 | +1.38 (+29.0%) |
| 128x128 | 14.52 | 13.48 | +1.04 (+7.7%) |
| 512x512 | 77.55 | 76.22 | +1.33 (+1.7%) |
| 1024x1024 | 309.32 | 270.43 | +38.89 (+14.4%) |

**考察:**
- RustはC言語比で小規模グリッドで29.0%遅い
- 中規模(512x512)ではC言語比でほぼ同等(1.7%遅い)
- 最大規模でC言語比で14.4%遅い

---

## 総合分析

### オーバーヘッドのスケーラビリティ

| 実装 | 64x64 | 128x128 | 512x512 | 1024x1024 | 傾向 |
|:---|---:|---:|---:|---:|:---|
| Semaphore (Safe vs Unsafe) | 1.4% | 20.3% | 7.5% | 12.9% | 中規模で最大 |
| Barrier (Safe vs Unsafe) | 22.1% | 24.8% | 16.6% | 13.5% | 小規模で最大 |
| Rayon (Safe vs Unsafe) | 4.8% | 4.1% | -3.3% | -1.3% | 大規模で逆転 |
| Semaphore (Unsafe vs C) | 22.9% | 7.0% | 7.3% | 7.4% | 収束傾向 |
| Barrier (Unsafe vs C) | 11.2% | -4.2% | -7.7% | -7.3% | C言語超え |

### 主要な発見

1. **Unsafe Rustの効果**
   - Semaphore: 7-8%のオーバーヘッドでC言語に接近
   - Barrier: 中規模以上でC言語を上回る（最大7.7%高速）
   - Rayon: Unsafeの効果が限定的（並列化戦略に依存）

2. **Safe Rustのコスト**
   - 小規模グリッド: 20-35%のオーバーヘッド
   - 大規模グリッド: 5-21%のオーバーヘッド
   - 実装によって大きく変動

3. **グリッドサイズの影響**
   - 小規模: 初期化や同期のオーバーヘッドが支配的
   - 中規模: 境界チェックや安全性検証のコストが顕在化
   - 大規模: 計算量が支配的となり、相対的オーバーヘッドが低下（ただしSemaphoreは例外）

4. **最適な選択**
   - **性能重視**: Barrier Unsafe（C言語を上回る）
   - **安全性と性能のバランス**: Rayon Safe（オーバーヘッド最小、大規模で1.3%）
   - **C言語との互換性**: Semaphore Unsafe（7-8%のオーバーヘッド）
